<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>人脸门禁 - 识别</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>人脸识别门禁</h1>
        <div class="video-container">
            <video id="video" width="640" height="480" autoplay playsinline></video>
            <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
        </div>
        <a href="register.html">去注册</a>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const toast = document.getElementById('toast');

        // 显示 Toast 通知的函数
        function showToast(message, isSuccess) {
            toast.textContent = message;
            toast.className = 'toast show';
            toast.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
            setTimeout(() => {
                toast.className = 'toast';
            }, 2000); // 2秒后自动隐藏
        }

        // 启动摄像头
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                console.error("无法访问摄像头: ", err);
                alert('无法访问摄像头，请检查权限。');
            }
        }

        // 定时捕捉并识别人脸
        setInterval(async () => {
            // 将视频帧绘制到 canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            // 从 canvas 获取图片 blob 数据
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('photo', blob, 'capture.jpg');

                try {
                    const response = await fetch('/recognize', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.status === 'pass') {
                        showToast(`Hello, ${result.name}`, true);
                    } else if (result.status === 'fail') {
                        if (result.message !== '未检测到人脸') { // 只有在检测到人脸但未通过时才显示
                            showToast('我还不认识你，去注册吧', false);
                        }
                    }
                } catch (error) {
                    console.error('识别请求失败', error);
                }
            }, 'image/jpeg');
        }, 2500); // 每2.5秒识别一次

        startCamera();
    </script>
</body>

</html>